<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Contador Mobile-Friendly</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        background: #121212;
        color: #f4f4f4;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    h1 {
        text-align: center;
        color: #66ccff;
        margin: 15px 0;
    }
    #totalGeral {
        text-align: center;
        font-size: 18px;
        margin-bottom: 10px;
        color: #99ccff;
        font-weight: bold;
    }
    #container {
        flex: 1;
        max-width: 600px;
        margin: auto;
        background: #1e1e1e;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(102, 204, 255, 0.3);
        overflow-y: auto;
        max-height: 60vh;
        scroll-behavior: smooth;
    }
    input[type="text"] {
        background: #2a2a2a;
        color: white;
        border: 1px solid #66ccff;
        padding: 12px;
        border-radius: 5px;
        width: 100%;
        margin-bottom: 10px;
        font-size: 16px;
    }
    button {
        cursor: pointer;
        border: none;
        padding: 12px 16px;
        border-radius: 6px;
        font-weight: bold;
        font-size: 16px;
        margin: 3px;
        min-width: 60px;
        flex: 1;
        transition: 0.1s;
    }
    button:active {
        filter: brightness(0.8);
    }
    .contador {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin: 5px 0;
        border: 1px solid #66ccff;
        border-radius: 8px;
        background: #2a2a2a;
        flex-wrap: wrap;
        touch-action: pan-y;
    }
    .contador span { font-size: 18px; margin: 5px; }
    .botoes {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
    }
    .mais { background: #66ccff; color: black; }
    .menos { background: #3399ff; color: white; }
    .reset { background: #3399ff; color: white; }
    .excluir { background: #ff4d4d; color: white; }
    .resetAll { background: #ff66cc; color: white; margin-left: 5px; }

    #graficoContainer {
        max-width: 600px;
        margin: 10px auto;
        background: #1e1e1e;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(102, 204, 255, 0.2);
        height: auto;
    }
    #graficoPizza {
        width: 100% !important;
        max-height: 300px; /* altura máxima no mobile */
    }

    #btnFlutuante {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #66ccff;
        color: black;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 0 15px rgba(102, 204, 255, 0.5);
        z-index: 1000;
        transition: 0.1s;
    }
    #btnFlutuante:active { filter: brightness(0.8); }

    @media(max-width: 400px){
        #btnFlutuante { width: 50px; height: 50px; font-size: 28px; }
    }
</style>
</head>
<body>
<h1>Contador Mobile</h1>
<div id="totalGeral">Total Geral: 0</div>

<div id="container">
    <input type="text" id="novoNome" placeholder="Nome do tópico">
    <button onclick="adicionarTopico()">Adicionar</button>
    <button onclick="exportar()">Exportar</button>
    <input type="file" id="importarArquivo" style="display:none" accept=".json" onchange="importarArquivo(event)">
    <button onclick="document.getElementById('importarArquivo').click()">Importar</button>
    <button class="resetAll" onclick="resetarTodos()">Resetar Todos</button>
    <div id="lista"></div>
</div>

<div id="graficoContainer">
    <canvas id="graficoPizza"></canvas>
</div>

<div id="btnFlutuante" onclick="document.getElementById('novoNome').focus()">+</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
let contadores = JSON.parse(localStorage.getItem("contadores")) || [];
let chart = null;

function gerarCor(nome) {
    let hash = 0;
    for (let i = 0; i < nome.length; i++) hash = nome.charCodeAt(i) + ((hash << 5) - hash);
    const h = hash % 360;
    const s = 70 + (hash % 10);
    const l = 50 + (hash % 10);
    return `hsl(${h}, ${s}%, ${l}%)`;
}

function salvar() { localStorage.setItem("contadores", JSON.stringify(contadores)); }

function atualizarTotal() {
    let total = contadores.reduce((acc, item) => acc + item.valor, 0);
    document.getElementById("totalGeral").textContent = `Total Geral: ${total}`;
}

function atualizarGrafico() {
    const labels = contadores.map(c => c.nome);
    const data = contadores.map(c => c.valor);
    const colors = labels.map(c => gerarCor(c));

    const config = {
        type: 'pie',
        data: { labels, datasets: [{ data, backgroundColor: colors }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { animateRotate: true, animateScale: true, duration: 600 },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: 'white',
                    formatter: (value, ctx) => {
                        let total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                        let pct = total ? (value/total*100).toFixed(1) : 0;
                        return pct + '%';
                    },
                    font: { weight: 'bold', size: 14 }
                }
            }
        },
        plugins: [ChartDataLabels]
    };

    if(chart){
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.data.datasets[0].backgroundColor = colors;
        chart.update();
        return;
    }

    const ctx = document.getElementById('graficoPizza').getContext('2d');
    chart = new Chart(ctx, config);
}

// Função para incrementar/decrementar continuamente
function startHold(btn, action) {
    let interval;
    const start = () => { action(); interval = setInterval(action, 150); };
    const stop = () => clearInterval(interval);
    btn.addEventListener('mousedown', start);
    btn.addEventListener('mouseup', stop);
    btn.addEventListener('mouseleave', stop);
    btn.addEventListener('touchstart', start);
    btn.addEventListener('touchend', stop);
}

function adicionarSwipe(div, index) {
    let startX = 0;
    div.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
    div.addEventListener('touchend', e => {
        let diff = e.changedTouches[0].clientX - startX;
        if(diff < -100) { 
            if(confirm(`Excluir "${contadores[index].nome}"?`)) {
                contadores.splice(index,1);
                salvar(); renderizar();
            }
        } else if(diff > 100) { 
            contadores[index].valor = 0;
            salvar(); renderizar();
        }
    });
}

function renderizar() {
    const lista = document.getElementById("lista");
    lista.innerHTML = "";
    contadores.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "contador";

        const titulo = document.createElement("span");
        titulo.textContent = item.nome;

        const spanValor = document.createElement("span");
        spanValor.textContent = item.valor;

        const botoes = document.createElement("div");
        botoes.className = "botoes";

        // Botões
        const btnMais = document.createElement("button");
        btnMais.textContent = "+";
        btnMais.className = "mais";
        startHold(btnMais, () => { contadores[index].valor++; salvar(); renderizar(); });

        const btnMenos = document.createElement("button");
        btnMenos.textContent = "-";
        btnMenos.className = "menos";
        startHold(btnMenos, () => { if(contadores[index].valor>0) contadores[index].valor--; salvar(); renderizar(); });

        const btnMais10 = document.createElement("button");
        btnMais10.textContent = "+10";
        btnMais10.className = "mais";
        btnMais10.onclick = () => { contadores[index].valor += 10; salvar(); renderizar(); };

        const btnMenos10 = document.createElement("button");
        btnMenos10.textContent = "-10";
        btnMenos10.className = "menos";
        btnMenos10.onclick = () => { if(contadores[index].valor>0) contadores[index].valor = Math.max(0, contadores[index].valor - 10); salvar(); renderizar(); };

        const btnReset = document.createElement("button");
        btnReset.textContent = "Reset";
        btnReset.className = "reset";
        btnReset.onclick = () => { 
            if(confirm(`Deseja realmente resetar "${item.nome}"?`)) {
                contadores[index].valor = 0; salvar(); renderizar();
            }
        };

        const btnExcluir = document.createElement("button");
        btnExcluir.textContent = "Excluir";
        btnExcluir.className = "excluir";
        btnExcluir.onclick = () => {
            if (confirm(`Deseja excluir "${item.nome}"?`)) {
                contadores.splice(index, 1); salvar(); renderizar();
            }
        };

        botoes.appendChild(btnMenos10);
        botoes.appendChild(btnMenos);
        botoes.appendChild(btnMais);
        botoes.appendChild(btnMais10);
        botoes.appendChild(btnReset);
        botoes.appendChild(btnExcluir);

        div.appendChild(titulo);
        div.appendChild(spanValor);
        div.appendChild(botoes);

        lista.appendChild(div);

        adicionarSwipe(div, index);
    });

    atualizarTotal();
    atualizarGrafico();
}

window.onload = () => document.getElementById('novoNome').focus();

function adicionarTopico() {
    const nome = document.getElementById("novoNome").value.trim();
    if (!nome) return alert("Digite um nome para o tópico!");
    contadores.push({ nome, valor: 0 });
    salvar(); renderizar();
    document.getElementById("novoNome").value = "";
}

function resetarTodos() {
    if(!contadores.length) return alert("Não há contadores!");
    if(confirm("Resetar todos os contadores?")) {
        contadores.forEach(c=>c.valor=0); salvar(); renderizar();
    }
}

function exportar() {
    const blob = new Blob([JSON.stringify(contadores)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="contadores_backup.json";
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

function importarArquivo(event) {
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const dados = JSON.parse(e.target.result);
            if(Array.isArray(dados)) { contadores=dados; salvar(); renderizar(); alert("Importado com sucesso!"); }
            else alert("Arquivo inválido");
        } catch { alert("Erro ao ler arquivo"); }
    }
    reader.readAsText(file);
}

renderizar();
</script>
</body>
</html>